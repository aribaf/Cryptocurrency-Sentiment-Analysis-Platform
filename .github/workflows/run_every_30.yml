name: Run crypto backend every 30 minutes (logs saved)

on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes
  workflow_dispatch:         # allows manual run from Actions â†’ Run workflow

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system deps (for playwright/chrome)
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libpangocairo-1.0-0 libasound2 libxss1 libgtk-3-0

      - name: Install Python packages (cached)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Pip install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || pip install playwright selenium transformers torch pymongo python-dotenv pandas praw || true; else pip install playwright selenium transformers torch pymongo python-dotenv pandas praw || true; fi
          # install playwright browsers
          python -m playwright install --with-deps chromium

      - name: Create logs directory
        run: mkdir -p logs

      - name: Create .env from repo secrets
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          echo "MONGO_URI=${MONGO_URI}" > .env
          echo "REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}" >> .env
          echo "REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}" >> .env
          echo "REDDIT_USER_AGENT=${REDDIT_USER_AGENT}" >> .env
          echo "TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}" >> .env
          echo "HEADLESS=true" >> .env

      - name: Run news.py (one cycle)
        run: |
          echo "=== START news.py ===" > logs/news.log
          python news.py >> logs/news.log 2>&1 || true
          echo "=== END news.py ===" >> logs/news.log

      - name: Run automation.py (one cycle)
        run: |
          echo "=== START automation.py ===" > logs/automation.log
          python automation.py >> logs/automation.log 2>&1 || true
          echo "=== END automation.py ===" >> logs/automation.log

      - name: Run sentiment_aggregator.py (one cycle)
        run: |
          echo "=== START sentiment_aggregator.py ===" > logs/aggregator.log
          python sentiment_aggregator.py >> logs/aggregator.log 2>&1 || true
          echo "=== END sentiment_aggregator.py ===" >> logs/aggregator.log

      - name: Run sentiment_analyzer.py (one cycle)
        run: |
          echo "=== START sentiment_analyzer.py ===" > logs/analyzer.log
          python sentiment_analyzer.py >> logs/analyzer.log 2>&1 || true
          echo "=== END sentiment_analyzer.py ===" >> logs/analyzer.log

      - name: Run twitter_scraper_selenium.py (one cycle)
        run: |
          echo "=== START twitter_scraper_selenium.py ===" > logs/twitter.log
          python twitter_scraper_selenium.py >> logs/twitter.log 2>&1 || true
          echo "=== END twitter_scraper_selenium.py ===" >> logs/twitter.log

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: logs
