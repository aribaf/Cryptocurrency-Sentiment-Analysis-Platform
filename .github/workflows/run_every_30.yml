name: Run crypto backend every 30 minutes (logs saved)

on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes
  workflow_dispatch:         # allows manual run from Actions â†’ Run workflow

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system libs for browsers (adjusted)
        run: |
          sudo apt-get update
          # install a minimal set of libraries Playwright/Chromium needs
          sudo apt-get install -y --no-install-recommends \
            libnss3 \
            libatk1.0-0 \
            libcups2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libpangocairo-1.0-0 \
            libasound2-plugins \
            libxss1 \
            libgtk-3-0

          # let playwright also try to install deps (this is idempotent)
          # (the python package provides `playwright install-deps`)
          python -m pip install --upgrade pip setuptools
          pip install playwright || true
          python -m playwright install-deps || true

      - name: Install Python packages (CPU PyTorch + others)
        run: |
          python -m pip install --upgrade pip

          # Install CPU-only PyTorch wheels (avoids huge GPU wheels and many failures)
          pip install --no-cache-dir \
            --index-url https://download.pytorch.org/whl/cpu \
            torch torchvision torchaudio \
            --extra-index-url https://pypi.org/simple

          # Install other required packages (including sentencepiece for transformers models)
          pip install --no-cache-dir playwright selenium transformers pymongo python-dotenv pandas praw sentencepiece

          # Install Playwright browser binaries (chromium)
          python -m playwright install chromium

      - name: Create logs directory
        run: mkdir -p logs

      - name: Create .env from repo secrets
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          echo "MONGO_URI=${MONGO_URI}" > .env
          echo "REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}" >> .env
          echo "REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}" >> .env
          echo "REDDIT_USER_AGENT=${REDDIT_USER_AGENT}" >> .env
          echo "TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}" >> .env
          echo "HEADLESS=true" >> .env

      - name: Run news.py (one cycle)
        run: |
          echo "=== START news.py ===" > logs/news.log
          python news.py >> logs/news.log 2>&1 || true
          echo "=== END news.py ===" >> logs/news.log

      - name: Run automation.py (one cycle)
        run: |
          echo "=== START automation.py ===" > logs/automation.log
          python automation.py >> logs/automation.log 2>&1 || true
          echo "=== END automation.py ===" >> logs/automation.log

      - name: Run sentiment_aggregator.py (one cycle)
        run: |
          echo "=== START sentiment_aggregator.py ===" > logs/aggregator.log
          python sentiment_aggregator.py >> logs/aggregator.log 2>&1 || true
          echo "=== END sentiment_aggregator.py ===" >> logs/aggregator.log

      - name: Run sentiment_analyzer.py (one cycle)
        run: |
          echo "=== START sentiment_analyzer.py ===" > logs/analyzer.log
          python sentiment_analyzer.py >> logs/analyzer.log 2>&1 || true
          echo "=== END sentiment_analyzer.py ===" >> logs/analyzer.log

      - name: Run twitter_scraper_selenium.py (one cycle)
        run: |
          echo "=== START twitter_scraper_selenium.py ===" > logs/twitter.log
          python twitter_scraper_selenium.py >> logs/twitter.log 2>&1 || true
          echo "=== END twitter_scraper_selenium.py ===" >> logs/twitter.log

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: logs
